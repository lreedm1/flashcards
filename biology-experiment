import os
import re
from itertools import count

from titlecase import titlecase

from card_analysis import make_connections, weight, write

dataset = "/Users/reed/Documents/Nightly/bio test set.txt"
dictionary = "/Users/reed/Documents/Nightly/punc_free_dictionary.txt"
directory = "/Users/reed/Library/Mobile Documents/iCloud~md~obsidian/Documents/biology test"

def user_input(prompt, responses, error_message): # Ask the user a question and return their response
    while True:
        x = input(prompt)
        if x in responses:
            return x
        elif x == 'q':
            quit()
        else:
            print(error_message)
            continue


def titlecase_plus(string): # run the string through titlecase but allow for acronyms
    split_on_space = re.split('\s+', string) # split the string on spaces
    acronyms = []
    for i in range(len(split_on_space)): 
        if split_on_space[i].upper() == split_on_space[i]: # if the word is all caps, add it to the acronyms list
            length = len(split_on_space[i])
            start = string.find(split_on_space[i])
            acronyms.append([start, start + length, split_on_space[i]])
        
    string_titlecase = titlecase(string)
    for i in acronyms: # replace the acronyms with the original capitalization
        string_titlecase = string_titlecase[:i[0]] + i[2] + string_titlecase[i[1]:]

    return string_titlecase


def make_directory(path, file):
    # read the file and save it to a list called contents
    with open(dataset, 'r') as f:
        contents = f.read()
    
    # the file is a list of terms and definitions seperated by ';;' and ';;;' respectively
    # split the contents into a list of lists
    # first, replace all empty terms with '*****'
    contents = contents.replace(';;;;;', '*****')
    contents = contents.split(";;;")
    # subdivide contents by ';;'
    contents = [x.split(';;') for x in contents]
    saved_contents = []
    # format the contents of the list
    for i in range(len(contents)):
        # print the contents to make sure regex is working
        try:
            # if the contents are less than two characters or contain the code "*****", skip the term
            if len(contents[i][1]) < 2 or "*****" in contents[i][1] or "*****" in contents[i][0]:
                print(f'{contents[i]} is to short or got flagged for being blank')
                continue
        except IndexError:
            print(f'{contents[i]} is too short')
            continue # skip the code below the try

        
        title = titlecase_plus(contents[i][0]) # titlecase the term
        title = title.replace("/", "or") # replace slashes with 'or'
        title = title.replace('\\', 'or') # replace backslashes with 'or'

        # if the content does not contain adjacanet capital letters, capitalize the first letter
        for a in range(len(title)-1):
            if title[a].isupper() and title[a+1].isupper():
                break
        else:
            title = title[0].upper() + title[1:]
        
        definition = contents[i][1]
        definition = definition[0].upper() + definition[1:] # capitalize the first letter
        if definition[-1] == ".": # if definition ends with a period, remove it
            definition = definition[:-1]

        print(title + " created")

        saved_contents.append([title, definition]) 
        # create a card for each term
        # it is not written to disk until write_cards is called
        
        # convert saved_contents to a tuple so it is not overwritten

    return saved_contents


def write_cards(cards, directory):
    print("writing cards")
    #input("Press enter to continue")
    for i in range(len(cards)):
        filename = f'{directory}/{cards[i][0]}.md'
        write(filename, cards[i][1])
        print(f'{cards[i][0]} written to disk')

 
def remove_duplicates(cards):
    # remove all duplicate terms by adding the next term to the first term, then delete the second term
    y = 0 # y accounts for the number of duplicates removed
    for i in range(len(cards)):
        x = 0 # x functions as a counter for the number of times the first term has been added to the second term
        for j in range(i + 1, len(cards)):
            j -= x # j is the index of the second term, and x is the number of times the first term has been added to the second term
            if cards[i][0] == cards[j][0]:
                # add "Definition 1:\n" to "Term 1", then "Definition 2\n" to "Term 1"
                
                if x == 0:
                    cards[i][1] = "Definition 1:\n" + cards[i][1]
                cards[i][1] += "\n\n" + "Definition " + str(x + 2) + ":\n" + cards[j][1]
                # remove the second term from the list
                print(f'Removing {cards[j][0]}')
                cards.pop(j)

                x += 1
                y += 1
    return cards


def main():
    cards = make_directory(directory, dataset)
    weight(cards, dictionary, directory)
    cards = remove_duplicates(cards)
    cards = make_connections(cards)

    write_cards(cards, directory)
    
main()
